% ----------------------------------------------------
% Sensing Subsystem
% ----------------------------------------------------
\documentclass[class=report,11pt,crop=false]{standalone}
\input{../Style/ChapterStyle.tex}
\input{../FrontMatter/Glossary.tex}
\begin{document}
	% ----------------------------------------------------
	\chapter{Sensing Subsystem (NXSMPI001)}
	\vspace{0.5cm}
	% ----------------------------------------------------
	\section{Introduction}
	The aim of this subsystem is to translate the force from the bird's weight on the scale into a digital reading. It involves designing and constructing the circuitry needed to change the weight into a analogue voltage, developing the algorithms in the micro-controller unit (MCU) used to process this signal and change it into a weight reading of the bird. Another component to this subsystem is to have accurate timekeeping so the weight data is timestamped. 
	
	\section{Requirements Analysis}
	\begin{table}[h!]
		\centering
		\caption{Non-functional Specifications of the Sensing Subsystem}
		\label{tab:S1}
			\begin{tabularx}{0.8\textwidth}{ 
					| >{\centering\arraybackslash}X 
					| >{\centering\arraybackslash}X 
					| >{\centering\arraybackslash}X |}
			\hline
			\textbf{User   Requirement} & \textbf{Specification   Description}                                     & \textbf{Specification   no.} \\ \hline
			Portable                    & The final   circuitry must be able to fit in a box that is 100x100x50mm. & SS1                          \\ \hline
			Long battery   life         & The final   circuitry should consume less than 30mA.                     & SS2                          \\ \hline
			\end{tabularx}
	\end{table}
	
	\begin{table}[h!]
		\centering
		\caption{Functional Specifications for Sensing Subsystem}
		\label{tab:S2}
			\begin{tabularx}{0.8\textwidth}{ 
					| >{\centering\arraybackslash}X 
					| >{\centering\arraybackslash}X 
					| >{\centering\arraybackslash}X |}
				\hline
				\textbf{User   Requirement}                                   & \textbf{Specification   Description}                                                                                                             & \textbf{Specification   no.} \\ \hline
				The scale   must measure weights of up to 500g.               & The weight   sensor must have a maximum capacity greater than 750g (1.5 times safety   factor).                                                  & SS3                          \\ \hline
				& The sensor   and amplifier must output a voltage proportional to the weight force applied   up to a weight of 500g.                              & SS4                          \\ \hline
				& Microcontroller   must an ADC to convert the output voltage into weight measurement.                                                             & SS5                          \\ \hline
				\multirow{2}{0.25\textwidth}{The scale   measure weight accurate to 0.1g.} & The ADC must   be able to resolve voltage changes from weight changes that are less than   0.1g.                                                 & SS6                          \\ \cline{2-3} 
				& The ADC must   have a gain and offset error less than a voltage change resulting from a   change in weight of 0.1g.                              & SS7                          \\ \hline
				\multirow{3}{0.25\textwidth}{The scale   must have a tare function}        & The   microcontroller must have a digital input pin to read the users inputs from a   push button.                                               & SS8                          \\ \cline{2-3} 
				& The   microcontroller must subtract the current weight from all subsequent   measurements when the voltage on the digital pin receives an input. & SS9                          \\ \cline{2-3} 
				& There must be   an LED that indicates when the scale is in tare mode.                                                                            & SS10                         \\ \hline
				The scale must   be battery powered.                          & The microcontroller   and all the surrounding circuitry must be able to operate on one positive   rail.                                          & SS11                         \\ \hline
			\end{tabularx}
	\end{table}
	
	\section{Design Process}
	
	\subsection{Microcontroller Unit (MCU)}
	The Arduino was chosen as its Integrated Development Environment (IDE) has ample support and libraries which will make interfacing with all different modules simple and straightforward. Within the Arduino family the Arduino Nano was initially chosen as it was one of the cheapest Arduino and it came in a small form factor. However, the User Interface subsystem required a WiFi or Bluetooth module so the Arduino Nano 33 IoT was chosen instead. Although BLE and BLE Sense also meet these requirements, they come with additional sensors that are unnecessary. All the Arduino chips also come with several low power modes that can be leveraged to reduce power consumption.
	
	\subsection{Weight Sensor}
	A strain gauge is an electrical component whose resistance changes when a force is applied to it. Strain gauges work on the principle that when the resistance of a conductor is proportional to its length, as shown in the equation below. 
	\[R = \rho \frac{L}{A}\]
	One solution is to put a strain gauge in series with another resistance, then place the strain gauge on a beam. When the beam deflects under the bird’s weight, the change in voltage across the strain gauge can be measured. The issue with this setup is that the change in resistance, and thus the subsequent change in voltage, will be very small. This means a very high resolution ADC will be required to resolve these small changes in voltage. The resolution required could be reduced by amplifying the signal, however this would also amplify the DC offset introduced by the voltage divider, quickly saturating the output.
	
	A better solution is a load cell which has 4 strain gauges in a Wheatstone configuration. This means that when the load cell has no load on it, the voltage will be zero, and when the device deflects, there will be a slight voltage difference between it’s 2 output terminals. As discussed above, this output can be sent through an amplifier thus reducing the resolution required for the ADC. To meet the sensor specifications, a 1kg load cell will be used. 
	
	The specifications for one such load cell by HKD is shown in Table \ref{tab:S3} below.

	\begin{table}[h!]
		\centering
		\caption{Table on load cell specifications}
		\begin{tabularx}{0.8\textwidth} { 
				| >{\centering\arraybackslash}X 
				| >{\centering\arraybackslash}X |}
			\hline
			Rated Load & 1kg \\
			\hline
			Rated Output & 1.0 ± 0.15mV/V \\
			\hline
			Zero Output & ±0.1mV/V \\
			\hline
			Input Impedance & 1115 ± 10$\Omega$ \\
			\hline
			Output Impedance & 1000 ± 10$\Omega$ \\
			\hline
		\end{tabularx}
		\label{tab:S3}
	\end{table}
	
	At the rated load, the output will be $0.001V_{cc}$, hence the amplifier needs a gain of 1000. 
	
	\subsection{Sensor Amplifier}
	From Table \ref{tab:S3}, the output impedance of the load cell is quite significant, meaning there will need to be an input buffer between it and the amplifier to avoid loading. The instrumentation amplifier is thus ideal circuit for achieving this and it is shown in Figure \ref{fig:S1} below.
	
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.9\linewidth]{Figures/Amplifier.png}
		\caption{Circuit Schematic of Instrumentation Amplifier}
		\label{fig:S1}
	\end{figure}
	
	The circuit has three stages. The first stage has two input buffers which also amplify the input signal. The second is a differential amplifier which is a circuit whose output is proportional to the difference between the two inputs. The final stage is a low pass filter. The final output voltage is related to the input voltage by the expression below.
	\[V_{out} = (V_2 - V_1) \left(1 + \frac{2(R_2+R_3)}{R_1}\right) \left(\frac{R_9}{R_6}\right) \]
	From the expression above, when the load cell is connected to the two input terminals, its output will be amplified by a factor of 994, which is close to the gain required. 
	The amplifier have such a large gain presents two issues.
	
	The first is that real op-amps have an input offset voltage. As the offsets from the input stage propagate through the circuit, they are amplified resulting in the output having a large bias and saturating for very small weights, hence the op-amps used were the TL071P. These are JFET op-amps meaning they have a very low input offset voltage, in this case, of 1mV. This is still large in comparison to the input, but they also come with two NULL pins which allows the input offset to be adjusted, and thus reduced to 0. The is the purpose of potentiometer RV1 in Figure \ref{fig:S1}. Another reason for choosing TL071P is that their minimum recommended supply voltage is 4.5V which means unlike other JFET op-amps they can operate at lower supply voltages. This advantageous since the scale will be battery powered so there will not be a large supply.
	
	The second is that noise from the input will also be amplified as it propagates through circuit, making the final output difficult to measure. The low pass filter in the final stage addresses this. Since output is a DC voltage, ideally the cutoff frequency should be as low as possible to attenuate the most amount of noise, but this would have a negative impact on the rise time. A lower cutoff frequency would also require larger capacitors. The sample rate for final system will be 10Hz (discussed later). This equates to a period of 0.1s and ideally the output should settle within half that time. It takes 5 time constants for the output to settle to 99\% of its final value. This means that $5RC = 0.05s$ or $RC = 0.01s$. If a 100k$\Omega$ resistor is used then the capacitor would need 100nF. The filter also needs a steep roll-off to ensure a clean output, so a second stage can be added at the input, to make it a second order filter. The input stage of this filter needs to have much lower impedance than output stage to avoid loading, which would resulting in the filter having a larger cutoff frequency than was calculated. Using a 10k$\Omega$ resistor, the capacitor needed would be 1uF. The equates to a cutoff frequency of 16Hz. It is difficult to know the exact rise time for higher order filters from calculation alone, as such, this filter was simulated in LTSpice. The circuit diagram is shown in Figure \ref{fig:S2} below.
	
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.5\linewidth]{Figures/Filter.png}
		\caption{Circuit Schematic of Low Pass Filter}
		\label{fig:S2}
	\end{figure}
	
	The input was set to a 1$V_{pp}$ square wave with a frequency of 20Hz. Figure \ref{fig:S3} below shows the input and output of the circuit.
	
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.9\linewidth]{Figures/Filter Waveform.png}
		\caption{Input and Output Waveform of Filter}
		\label{fig:S3}
	\end{figure}
	
	From the waveform above it can be seen that the rise time is too large, as the output (in green) is barely settling in time for the next half-cycle. This can be rectified by halving the size of the capacitors to 470nF and 47nF, as seen in Figure \ref{fig:S1}. The new output is shown in Figure \ref{fig:S4} below.
	
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.9\linewidth]{Figures/Filter Waveform2.png}
		\caption{Input and Output Waveform of the Final Filter}
		\label{fig:S4}
	\end{figure}
	As seen above, the filter now meets the speed requirements.
	
	Since the instrumentation amplifier has op-amps, it needs 2 rail voltages, a positive and a negative. Unfortunately there is only a single supply, however this supply can be split in two with a simple op-amp circuit, as shown in Figure \ref{fig:S5} below.
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.5\linewidth]{Figures/Split Supply.png}
		\caption{Schematic of Split Supply Circuit}
		\label{fig:S5}
	\end{figure}
	
	If the new reference point is made to be "Virtual GND", then two rail voltages equal to $\pm \frac{V_{cc}}{2}$ are obtained. This does mean that output of the amplifier will have an offset of $\frac{V_{cc}}{2}$, but this can be stepped down using a voltage divider as to not damage the input to the microcontroller. In testing, a 5V supply was initially used but this resulted in the op-amps saturating. In the early stages of the design process, the amplifier was tested using $\pm3.3V$ and this worked fine so in the end a 6.6V supply was chosen. This will be the supply voltage required from the Power Subsystem. The Arduino Nano 33 IoT has an operating voltage of 3.3V so the voltage divider must have a gain of 0.5.
	
	Finally, because the output from the amplifier will no longer go directly to the microcontroller, an op-amp must be included in the low pass filter to buffer the input of the voltage divider. The new active low pass filter will be in a Sallen-Key configuration with $R = 100k\omega$ and $C = 47nF$ as shown in Figure \ref{fig:S1}.
	
	\subsection{Analogue to Digital Converter (ADC)}
	Since the weight force on the load cell is proportional to output voltage out of the load cell, the change in weight is equal to the change voltage as shown in the equation below.
	\begin{center}
		$\frac{W_1}{W_2} = \frac{V_1}{V_2}$ \\ 
	\end{center}
	By substituting in the rated load, rated output and the minimum weight, the smallest change in the output can be determined.
	\begin{center}
		$\frac{0.1g}{1000g} = \frac{V_{min}}{0.5(994(3.3mV))}$ \\
		$V_{min} = 0.164mV$
	\end{center}
	As such, 1 LSB (Least Significant Bit) of ADC must be less than 0.164mV. Since the supply voltage from the Arduino is 3.3V, an ADC with a minimum resolution of 15 bits is required. The Arduino only comes with a 12-bit ADC so an external module will be needed.
	The module that was chosen is the ADS1115 16 bit ADC its specification for this application are summarized in Table \ref{tab:S4} below.
		\begin{table}[h!]
		\centering
		\caption{Table on ADS1115 specifications}
		\begin{tabularx}{0.8\textwidth} { 
				| >{\centering\arraybackslash}X 
				| >{\centering\arraybackslash}X |
				| >{\centering\arraybackslash}X |
				| >{\centering\arraybackslash}X |
				| >{\centering\arraybackslash}X |}
			\hline
			& \textbf{Min} & \textbf{Typical} & \textbf{Max} & \textbf{Unit} \\ \hline
			\textbf{Supply Voltage} & 2            & -                & 5.5          & V             \\ \hline
			\textbf{Data Rate}      & 8            & -                & 860          & SPS           \\ \hline
			\textbf{Offset error}   & -            & $\pm$ 3            & -            & LSB           \\ \hline
			\textbf{Gain error}     & -            & 0.01             & 0.15         & \%            \\ \hline
		\end{tabularx}
		\label{tab:S4}
	\end{table}
	
	From Table \ref{tab:S4}, the offset error is equivalent to 0.151mV which is less than $V_{min}$. The maximum gain error is quite large, translating to an offset of 4.95mV at the last output code. Even under typical conditions the offset will be 0.33mV. However this is not a big issue, as the scale only needs to be accurate over half the range and the gain error can be compensated for in software. The noise performance is also great as at low data rates, not a single bit of resolution is lost to quantization noise. The final reason this module was chosen is that most ADC come standalone in a SIOC package, but this one comes as a development board kit with headers allowing for easy soldering onto a Veroboard. The circuit diagram for this module is shown in Figure \ref{fig:S6} below.
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.5\linewidth]{Figures/ADC.png}
		\caption{Circuit Schematic of the ADS1115}
		\label{fig:S6}
	\end{figure}
	
	\section{Acceptance Test Procedure (ATP)}
	\subsection{Load Cell and Amplifier tests}
	The amplifier circuit built on the breadboard and connected to a 6.6V power supply. The split supply was tested by measuring the voltage of the positive and negative rail with respect to 'Virtual GND' using a multimeter as shown in Figure \ref{fig:S7} below.
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.4\linewidth]{Figures/ATP1.png}
		\caption{Image of split supply test}
		\label{fig:S7}
	\end{figure}
	The input into the amplifier was connected to the waveform generator on the oscilloscope. The output with respect to 'Virtual GND' was measured using the oscilloscope and the output with respect to GND was measured using the multimeter (this is what the ADC would measure). The input was set to 0V DC and the potentiometer was adjusted until the measured output on the oscilloscope was also 0. The output to the Arduino was then measured using a multimeter. This was repeated for different input values until the output saturated. The measurement for the output when the input was 1mV DC is shown in \ref{fig:S8} below.
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.8\linewidth]{Figures/ATP2.png}
		\caption{Image of Amplifier test when input is 1mV}
		\label{fig:S8}
	\end{figure}
	
	The load cell was attached to a mock scale as shown below.
	% ----------------------------------------------------
	\ifstandalone
	\bibliography{../Bibliography/References.bib}
	\printnoidxglossary[type=\acronymtype,nonumberlist]
	\fi
\end{document}
% ----------------------------------------------------